<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2 Unit Testing Controllers 3.3.0.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Test Mixins Plugin
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingControllers.html"><strong>2</strong><span>Unit Testing Controllers</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingTagLibraries.html"><strong>3</strong><span>Unit Testing Tag Libraries</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingDomains.html"><strong>4</strong><span>Unit Testing Domains</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingFilters.html"><strong>5</strong><span>Unit Testing Filters</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingURLMappings.html"><strong>6</strong><span>Unit Testing URL Mappings</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/mockingCollaborators.html"><strong>7</strong><span>Mocking Collaborators</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/mockingCodecs.html"><strong>8</strong><span>Mocking Codecs</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestMetaprogramming.html"><strong>9</strong><span>Unit Test Metaprogramming</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/introduction.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/unitTestingTagLibraries.html"><strong>3</strong><span>Unit Testing Tag Libraries</span> >></a></div>
                


                <div class="project">
                    <h1>2 Unit Testing Controllers</h1>

                    <p><strong>Version:</strong> 3.3.0.BUILD-SNAPSHOT</p>
                </div>

                

                

<h1 id="unitTestingControllers">2 Unit Testing Controllers</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-plugins/grails-test-mixin-plugin/edit/master/src/main/docs/guide/unitTestingControllers.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect3">
<h4 id="_the_basics">The Basics</h4>
<div class="paragraph">
<p>You use the <code>grails.test.mixin.TestFor</code> annotation to unit test controllers. Using <code>TestFor</code> in this manner activates the <code>grails.test.mixin.web.ControllerUnitTestMixin</code> and its associated API. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test something</span><span class="delimiter">&quot;</span></span>() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding the <code>TestFor</code> annotation to a controller causes a new <code>controller</code> field to be automatically created for the controller under test.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>TestFor</code> annotation will also automatically annotate any public methods starting with "test" with JUnit 4&#8217;s @Test annotation. If any of your test method don&#8217;t start with "test" just add this manually
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To test the simplest "Hello World"-style example you can do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// Test class</span>
<span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">hello</span>() {
        render <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test hello</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        controller.hello()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>response</code> object is an instance of <code>GrailsMockHttpServletResponse</code> (from the package <code>org.codehaus.groovy.grails.plugins.testing</code>) which extends Spring&#8217;s <code>MockHttpServletResponse</code> class and has a number of useful methods for inspecting the state of the response.</p>
</div>
<div class="paragraph">
<p>For example to test a redirect you can use the <code>redirectedUrl</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">index</span>() {
        redirect <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>
    }
    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test index</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.index()

        <span class="key">then</span>:
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/simple/hello</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many actions make use of the parameter data associated with the request. For example, the 'sort', 'max', and 'offset' parameters are quite common. Providing these in the test is as simple as adding appropriate values to a special <code>params</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(PersonController)
<span class="type">class</span> <span class="class">PersonControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test list</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        params.sort = <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>
        params.max = <span class="integer">20</span>
        params.offset = <span class="integer">0</span>
        controller.list()

        <span class="key">then</span>:
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even control what type of request the controller action sees by setting the <code>method</code> property of the mock request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(PersonController)
<span class="type">class</span> <span class="class">PersonControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test save</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>
        controller.save()

        <span class="key">then</span>:
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is particularly important if your actions do different things depending on the type of the request. Finally, you can mark a request as AJAX like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(PersonController)
<span class="type">class</span> <span class="class">PersonControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test list</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>
        request.makeAjaxRequest()
        controller.getPage()

        <span class="key">then</span>:
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You only need to do this though if the code under test uses the <code>xhr</code> property on the request.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_view_rendering">Testing View Rendering</h4>
<div class="paragraph">
<p>To test view rendering you can inspect the state of the controller&#8217;s <code>modelAndView</code> property (an instance of <code>org.springframework.web.servlet.ModelAndView</code>) or you can use the <code>view</code> and <code>model</code> properties provided by the mixin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">home</span>() {
        render <span class="key">view</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">homePage</span><span class="delimiter">&quot;</span></span>, <span class="key">model</span>: [<span class="key">title</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>]
    }
    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test home</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.home()

        <span class="key">then</span>:
        view == <span class="string"><span class="delimiter">'</span><span class="content">/simple/homePage</span><span class="delimiter">'</span></span>
        model.title == <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the view string is the absolute view path, so it starts with a '/' and will include path elements, such as the directory named after the action&#8217;s controller.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_template_rendering">Testing Template Rendering</h4>
<div class="paragraph">
<p>Unlike view rendering, template rendering will actually attempt to write the template directly to the response rather than returning a <code>ModelAndView</code> hence it requires a different approach to testing.</p>
</div>
<div class="paragraph">
<p>Consider the following controller action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">display</span>() {
        render <span class="key">template</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">snippet</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the controller will look for a template in <code>grails-app/views/simple/_snippet.gsp</code>. You can test this as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test display</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.display()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">contents of the template</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, you may not want to render the real template, but just test that it was rendered. In this case you can provide mock Groovy Pages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test display with mock template</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        views[<span class="string"><span class="delimiter">'</span><span class="content">/simple/_snippet.gsp</span><span class="delimiter">'</span></span>] = <span class="string"><span class="delimiter">'</span><span class="content">mock template contents</span><span class="delimiter">'</span></span>
        controller.display()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">mock template contents</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_actions_which_return_a_map">Testing Actions Which Return A Map</h4>
<div class="paragraph">
<p>When a controller action returns a <code>java.util.Map</code> that <code>Map</code> may be inspected directly to assert that it contains the expected data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">showBookDetails</span>() {
        [<span class="key">title</span>: <span class="string"><span class="delimiter">'</span><span class="content">The Nature Of Necessity</span><span class="delimiter">'</span></span>, <span class="key">author</span>: <span class="string"><span class="delimiter">'</span><span class="content">Alvin Plantinga</span><span class="delimiter">'</span></span>]
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test show book details</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        <span class="keyword">def</span> model = controller.showBookDetails()

        <span class="key">then</span>:
        model.author == <span class="string"><span class="delimiter">'</span><span class="content">Alvin Plantinga</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_xml_and_json_responses">Testing XML and JSON Responses</h4>
<div class="paragraph">
<p>XML and JSON response are also written directly to the response. Grails' mocking capabilities provide some conveniences for testing XML and JSON response. For example consider the following action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">renderXml</span>() {
    render(<span class="key">contentType</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">text/xml</span><span class="delimiter">&quot;</span></span>) {
        book(<span class="key">title</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Great</span><span class="delimiter">&quot;</span></span>)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be tested using the <code>xml</code> property of the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test render xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.renderXml()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;book title='Great'/&gt;</span><span class="delimiter">&quot;</span></span>
        response.xml.@title.text() == <span class="string"><span class="delimiter">'</span><span class="content">Great</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>xml</code> property is a parsed result from Groovy&#8217;s <a href="http://groovy-lang.org/processing-xml.html">XmlSlurper</a> class which is very convenient for parsing XML.</p>
</div>
<div class="paragraph">
<p>Testing JSON responses is pretty similar, instead you use the <code>json</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// controller action</span>
<span class="keyword">def</span> <span class="function">renderJson</span>() {
    render(<span class="key">contentType</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>) {
        book <span class="string"><span class="delimiter">&quot;</span><span class="content">Great</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test render json</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.renderJson()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">{&quot;book&quot;:&quot;Great&quot;}</span><span class="delimiter">'</span></span>
        response.json.book == <span class="string"><span class="delimiter">'</span><span class="content">Great</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>json</code> property is an instance of <code>org.codehaus.groovy.grails.web.json.JSONElement</code> which is a map-like structure that is useful for parsing JSON responses.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_xml_and_json_requests">Testing XML and JSON Requests</h4>
<div class="paragraph">
<p>Grails provides various convenient ways to automatically parse incoming XML and JSON packets. For example you can bind incoming JSON or XML requests using Grails' data binding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">consumeBook</span>(<span class="predefined-type">Book</span> b) {
    render <span class="string"><span class="delimiter">&quot;</span><span class="content">The title is </span><span class="inline"><span class="inline-delimiter">${</span>b.title<span class="inline-delimiter">}</span></span><span class="content">.</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test this Grails provides an easy way to specify an XML or JSON packet via the <code>xml</code> or <code>json</code> properties. For example the above action can be tested by specifying a String containing the XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="annotation">@Mock</span>([<span class="predefined-type">Book</span>])
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {
    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test consume book xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.xml = <span class="string"><span class="delimiter">'</span><span class="content">&lt;book&gt;&lt;title&gt;Wool&lt;/title&gt;&lt;/book&gt;</span><span class="delimiter">'</span></span>
        controller.consumeBook()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">The title is Wool.</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or alternatively a domain instance can be specified and it will be auto-converted into the appropriate XML request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="annotation">@Mock</span>([<span class="predefined-type">Book</span>])
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test consume book xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.xml = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>: <span class="string"><span class="delimiter">'</span><span class="content">Shift</span><span class="delimiter">'</span></span>)
        controller.consumeBook()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">The title is Shift.</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same can be done for JSON requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="annotation">@Mock</span>([<span class="predefined-type">Book</span>])
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test consume book json</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.json = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>: <span class="string"><span class="delimiter">'</span><span class="content">Shift</span><span class="delimiter">'</span></span>)
        controller.consumeBook()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">The title is Shift.</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer not to use Grails' data binding but instead manually parse the incoming XML or JSON that can be tested too. For example consider the controller action below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">consume</span>() {
    request.withFormat {
        xml {
            render <span class="string"><span class="delimiter">&quot;</span><span class="content">The XML Title Is </span><span class="inline"><span class="inline-delimiter">${</span>request.XML.@title<span class="inline-delimiter">}</span></span><span class="content">.</span><span class="delimiter">&quot;</span></span>
        }
        json {
            render <span class="string"><span class="delimiter">&quot;</span><span class="content">The JSON Title Is </span><span class="inline"><span class="inline-delimiter">${</span>request.JSON.title<span class="inline-delimiter">}</span></span><span class="content">.</span><span class="delimiter">&quot;</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test the XML request you can specify the XML as a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test consume xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.xml = <span class="string"><span class="delimiter">'</span><span class="content">&lt;book title=&quot;The Stand&quot;/&gt;</span><span class="delimiter">'</span></span>
        controller.consume()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">The XML Title Is The Stand.</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test consume json</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.json = <span class="string"><span class="delimiter">'</span><span class="content">{title:&quot;The Stand&quot;}</span><span class="delimiter">'</span></span>
        controller.consume()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">The JSON Title Is The Stand.</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_mime_type_handling">Testing Mime Type Handling</h4>
<div class="paragraph">
<p>You can test mime type handling and the <code>withFormat</code> method quite simply by setting the request&#8217;s <code>contentType</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// controller action</span>
<span class="keyword">def</span> <span class="function">sayHello</span>() {
    <span class="keyword">def</span> data = [<span class="key">Hello</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">World</span><span class="delimiter">&quot;</span></span>]
    request.withFormat {
        xml { render data <span class="keyword">as</span> grails.converters.XML }
        json { render data <span class="keyword">as</span> grails.converters.JSON }
        html data
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test say hello xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.contentType = <span class="string"><span class="delimiter">'</span><span class="content">application/xml</span><span class="delimiter">'</span></span>
        controller.sayHello()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;map&gt;&lt;entry key=&quot;Hello&quot;&gt;World&lt;/entry&gt;&lt;/map&gt;</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test say hello json</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.contentType = <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>
        controller.sayHello()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">{&quot;World&quot;}</span><span class="delimiter">'</span></span>[Hello]     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are constants provided by <code>ControllerUnitTestMixin</code> for all of the common common content types as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test say hello xml</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.contentType = XML_CONTENT_TYPE
        controller.sayHello()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;map&gt;&lt;entry key=&quot;Hello&quot;&gt;World&lt;/entry&gt;&lt;/map&gt;</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test say hello json</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        request.contentType = JSON_CONTENT_TYPE
        controller.sayHello()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">{&quot;World&quot;}</span><span class="delimiter">'</span></span>[Hello]     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The defined constants are listed below:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Constant</strong></th>
<th class="tableblock halign-left valign-top"><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*/\*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FORM_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/x-www-form-urlencoded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MULTIPART_FORM_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">multipart/form-data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text/html</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XHTML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/xhtml+xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/json</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT_XML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text/xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT_JSON_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">text/json</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HAL_JSON_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/hal+json</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HAL_XML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/hal+xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ATOM_XML_CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application/atom+xml</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_testing_duplicate_form_submissions">Testing Duplicate Form Submissions</h4>
<div class="paragraph">
<p>Testing duplicate form submissions is a little bit more involved. For example if you have an action that handles a form such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">handleForm</span>() {
    withForm {
        render <span class="string"><span class="delimiter">&quot;</span><span class="content">Good</span><span class="delimiter">&quot;</span></span>
    }.invalidToken {
        render <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>you want to verify the logic that is executed on a good form submission and the logic that is executed on a duplicate submission. Testing the bad submission is simple. Just invoke the controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test duplicate form submission</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.handleForm()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Bad</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Testing the successful submission requires providing an appropriate <code>SynchronizerToken</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="keyword">import</span> <span class="include">org.codehaus.groovy.grails.web.servlet.mvc.SynchronizerTokensHolder</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test valid form submission</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        <span class="keyword">def</span> tokenHolder = SynchronizerTokensHolder.store(session)

        params[SynchronizerTokensHolder.TOKEN_URI] = <span class="string"><span class="delimiter">'</span><span class="content">/controller/handleForm</span><span class="delimiter">'</span></span>
        params[SynchronizerTokensHolder.TOKEN_KEY] = tokenHolder.generateToken(params[SynchronizerTokensHolder.TOKEN_URI])
        controller.handleForm()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Good</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you test both the valid and the invalid request in the same test be sure to reset the response between executions of the controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="keyword">import</span> <span class="include">org.codehaus.groovy.grails.web.servlet.mvc.SynchronizerTokensHolder</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test form submission</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        controller.handleForm()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Bad</span><span class="delimiter">'</span></span>

        <span class="key">when</span>:
        response.reset()
        <span class="keyword">def</span> tokenHolder = SynchronizerTokensHolder.store(session)

        params[SynchronizerTokensHolder.TOKEN_URI] = <span class="string"><span class="delimiter">'</span><span class="content">/controller/handleForm</span><span class="delimiter">'</span></span>
        params[SynchronizerTokensHolder.TOKEN_KEY] = tokenHolder.generateToken(params[SynchronizerTokensHolder.TOKEN_URI])
        controller.handleForm()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Good</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_file_upload">Testing File Upload</h4>
<div class="paragraph">
<p>You use the <code>GrailsMockMultipartFile</code> class to test file uploads. For example consider the following controller action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">uploadFile</span>() {
    MultipartFile file = request.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">myFile</span><span class="delimiter">&quot;</span></span>)
    file.transferTo(<span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/local/disk/myFile</span><span class="delimiter">&quot;</span></span>))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test this action you can register a <code>GrailsMockMultipartFile</code> with the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="keyword">import</span> <span class="include">org.codehaus.groovy.grails.plugins.testing.GrailsMockMultipartFile</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test file upload</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        <span class="keyword">def</span> file = <span class="keyword">new</span> GrailsMockMultipartFile(<span class="string"><span class="delimiter">'</span><span class="content">myFile</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">some file contents</span><span class="delimiter">'</span></span>.bytes)
        request.addFile file
        controller.uploadFile()

        <span class="key">then</span>:
        file.targetFileLocation.path == <span class="string"><span class="delimiter">'</span><span class="content">/local/disk/myFile</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GrailsMockMultipartFile</code> constructor arguments are the name and contents of the file. It has a mock implementation of the <code>transferTo</code> method that simply records the <code>targetFileLocation</code> and doesn&#8217;t write to disk.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_command_objects">Testing Command Objects</h4>
<div class="paragraph">
<p>Special support exists for testing command object handling with the <code>mockCommandObject</code> method. For example consider the following action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">SimpleController</span> {
    <span class="keyword">def</span> <span class="function">handleCommand</span>(SimpleCommand simple) {
        <span class="keyword">if</span>(simple.hasErrors()) {
            render <span class="string"><span class="delimiter">'</span><span class="content">Bad</span><span class="delimiter">'</span></span>
        } <span class="keyword">else</span> {
            render <span class="string"><span class="delimiter">'</span><span class="content">Good</span><span class="delimiter">'</span></span>
        }
    }
}

<span class="type">class</span> <span class="class">SimpleCommand</span> {
    <span class="predefined-type">String</span> name

    <span class="directive">static</span> constraints = {
        name <span class="key">blank</span>: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test this you mock the command object, populate it and then validate it as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test valid command object</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>:
        <span class="keyword">def</span> simpleCommand = <span class="keyword">new</span> SimpleCommand(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Hugh</span><span class="delimiter">'</span></span>)
        simpleCommand.validate()

        <span class="key">when</span>:
        controller.handleCommand(simpleCommand)

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Good</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test invalid command object</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>:
        <span class="keyword">def</span> simpleCommand = <span class="keyword">new</span> SimpleCommand(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
        simpleCommand.validate()

        <span class="key">when</span>:
        controller.handleCommand(simpleCommand)

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Bad</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The testing framework also supports allowing Grails to create the command object instance automatically. To test this invoke the no-arg version of the controller action method. Grails will create an instance of the command object, perform data binding on it using the request parameters and validate the object just like it does when the application is running. See the test below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test valid command object</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        params.name = <span class="string"><span class="delimiter">'</span><span class="content">Hugh</span><span class="delimiter">'</span></span>
        controller.handleCommand()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Good</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test invalid command object</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        params.name = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
        controller.handleCommand()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Bad</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_allowedmethods">Testing allowedMethods</h4>
<div class="paragraph">
<p>The unit testing environment respects the <a href="../ref/Controllers/allowedMethods.html">allowedMethods</a> property in controllers.  If a controller action is limited to be accessed with certain request methods, the unit test must be constructed to deal with that.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/com/demo/DemoController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="type">class</span> <span class="class">DemoController</span> {

    <span class="directive">static</span> allowedMethods = [<span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>, <span class="key">update</span>: <span class="string"><span class="delimiter">'</span><span class="content">PUT</span><span class="delimiter">'</span></span>, <span class="key">delete</span>: <span class="string"><span class="delimiter">'</span><span class="content">DELETE</span><span class="delimiter">'</span></span>]

    <span class="keyword">def</span> <span class="function">save</span>() {
        render <span class="string"><span class="delimiter">'</span><span class="content">Save was successful!</span><span class="delimiter">'</span></span>
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/com/demo/DemoControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">javax.servlet.http.HttpServletResponse.*</span>

<span class="annotation">@TestFor</span>(DemoController)
<span class="type">class</span> <span class="class">DemoControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test a valid request method</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>
        controller.save()

        <span class="key">then</span>:
        response.status == SC_OK
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Save was successful!</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test an invalid request method</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">DELETE</span><span class="delimiter">'</span></span>
        controller.save()

        <span class="key">then</span>:
        response.status == SC_METHOD_NOT_ALLOWED
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_calling_tag_libraries">Testing Calling Tag Libraries</h4>
<div class="paragraph">
<p>You can test calling tag libraries using <code>ControllerUnitTestMixin</code>, although the mechanism for testing the tag called varies from tag to tag. For example to test a call to the <code>message</code> tag, add a message to the <code>messageSource</code>. Consider the following action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">showMessage</span>() {
    render g.message(<span class="key">code</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">foo.bar</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be tested as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(SimpleController)
<span class="type">class</span> <span class="class">SimpleControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test render message tag</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>:
        messageSource.addMessage <span class="string"><span class="delimiter">'</span><span class="content">foo.bar</span><span class="delimiter">'</span></span>, request.locale, <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>

        <span class="key">when</span>:
        controller.showMessage()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#unitTestingTagLibraries">unit testing tag libraries</a> for more information.</p>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/introduction.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/unitTestingTagLibraries.html"><strong>3</strong><span>Unit Testing Tag Libraries</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
