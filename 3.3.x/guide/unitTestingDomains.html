<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>4 Unit Testing Domains 3.3.0.RC1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Test Mixins Plugin
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingControllers.html"><strong>2</strong><span>Unit Testing Controllers</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingTagLibraries.html"><strong>3</strong><span>Unit Testing Tag Libraries</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingDomains.html"><strong>4</strong><span>Unit Testing Domains</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingFilters.html"><strong>5</strong><span>Unit Testing Filters</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestingURLMappings.html"><strong>6</strong><span>Unit Testing URL Mappings</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/mockingCollaborators.html"><strong>7</strong><span>Mocking Collaborators</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/mockingCodecs.html"><strong>8</strong><span>Mocking Codecs</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/unitTestMetaprogramming.html"><strong>9</strong><span>Unit Test Metaprogramming</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/unitTestingTagLibraries.html">&lt;&lt; <strong>3</strong><span>Unit Testing Tag Libraries</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/unitTestingFilters.html"><strong>5</strong><span>Unit Testing Filters</span> >></a></div>
                


                <div class="project">
                    <h1>4 Unit Testing Domains</h1>

                    <p><strong>Version:</strong> 3.3.0.RC1</p>
                </div>

                

                

<h1 id="unitTestingDomains">4 Unit Testing Domains</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-plugins/grails-test-mixin-plugin/edit/master/src/main/docs/guide/unitTestingDomains.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect3">
<h4 id="_overview">Overview</h4>
<div class="paragraph">
<p>Domain class interaction can be tested without involving a real database connection using <code>DomainClassUnitTestMixin</code>.</p>
</div>
<div class="paragraph">
<p>The GORM implementation in DomainClassUnitTestMixin is using a simple in-memory <code>ConcurrentHashMap</code> implementation. Note that this has limitations compared to a real GORM implementation.</p>
</div>
<div class="paragraph">
<p>A large, commonly-used portion of the GORM API can be mocked using <code>DomainClassUnitTestMixin</code> including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple persistence methods like <code>save()</code>, <code>delete()</code> etc.</p>
</li>
<li>
<p>Dynamic Finders</p>
</li>
<li>
<p>Named Queries</p>
</li>
<li>
<p>Query-by-example</p>
</li>
<li>
<p>GORM Events</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you wish to test GORM using a real database then it is recommended to use one of the following super classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>grails.test.hibernate.HibernateSpec</code> - Sets up Hibernate for the current test</p>
</li>
<li>
<p><code>grails.test.mongodb.MongoSpec</code> - Sets up MongoDB for the current test</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All features of GORM for Hibernate can be tested within a <code>HibernateSpec</code> unit test including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>String-based HQL queries</p>
</li>
<li>
<p>composite identifiers</p>
</li>
<li>
<p>dirty checking methods</p>
</li>
<li>
<p>any direct interaction with Hibernate</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The implementation behind <code>HibernateSpec</code> takes care of setting up the Hibernate with the in-memory H2 database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_domainclassunittestmixin_basics">DomainClassUnitTestMixin Basics</h4>
<div class="paragraph">
<p><code>DomainClassUnitTestMixin</code> is typically used in combination with testing either a controller, service or tag library where the domain is a mock collaborator defined by the <code>Mock</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(BookController)
<span class="annotation">@Mock</span>(<span class="predefined-type">Book</span>)
<span class="type">class</span> <span class="class">BookControllerSpec</span> <span class="directive">extends</span> Specification {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above tests the <code>BookController</code> class and mocks the behavior of the <code>Book</code> domain class as well. For example consider a typical scaffolded <code>save</code> controller action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">BookController</span> {
    <span class="keyword">def</span> <span class="function">save</span>() {
        <span class="keyword">def</span> book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(params)
        <span class="keyword">if</span> (book.save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)) {
            flash.message = message(
                    <span class="key">code</span>: <span class="string"><span class="delimiter">'</span><span class="content">default.created.message</span><span class="delimiter">'</span></span>,
                    <span class="key">args</span>: [message(<span class="key">code</span>: <span class="string"><span class="delimiter">'</span><span class="content">book.label</span><span class="delimiter">'</span></span>, <span class="keyword">default</span>: <span class="string"><span class="delimiter">'</span><span class="content">Book</span><span class="delimiter">'</span></span>), book.id])
            redirect(<span class="key">action</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">show</span><span class="delimiter">&quot;</span></span>, <span class="key">id</span>: book.id)
        }
        <span class="keyword">else</span> {
            render(<span class="key">view</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>, <span class="key">model</span>: [<span class="key">bookInstance</span>: book])
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests for this action can be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(BookController)
<span class="annotation">@Mock</span>(<span class="predefined-type">Book</span>)
<span class="type">class</span> <span class="class">BookControllerSpec</span> <span class="directive">extends</span> Specification {
   <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test saving an invalid book</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        controller.save()

        <span class="key">then</span>:
        model.bookInstance != <span class="predefined-constant">null</span>
        view == <span class="string"><span class="delimiter">'</span><span class="content">/book/create</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test saving a valid book</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        params.title = <span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>
        params.pages = <span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span>

        controller.save()

        <span class="key">then</span>:
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/book/show/1</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>
        <span class="predefined-type">Book</span>.count() == <span class="integer">1</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Mock</code> annotation also supports a list of mock collaborators if you have more than one domain to mock:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.Mock</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(BookController)
<span class="annotation">@Mock</span>([<span class="predefined-type">Book</span>, Author])
<span class="type">class</span> <span class="class">BookControllerSpec</span> <span class="directive">extends</span> Specification {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can also use the <code>DomainClassUnitTestMixin</code> directly with the <code>TestMixin</code> annotation and then call the <code>mockDomain</code> method to mock domains during your test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.TestMixin</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.domain.DomainClassUnitTestMixin</span>

<span class="annotation">@TestFor</span>(BookController)
<span class="annotation">@TestMixin</span>(DomainClassUnitTestMixin)
<span class="type">class</span> <span class="class">BookControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> setupSpec() {
         mockDomain(<span class="predefined-type">Book</span>)
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test saving an invalid book</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        controller.save()

        <span class="key">then</span>:
        model.bookInstance != <span class="predefined-constant">null</span>
        view == <span class="string"><span class="delimiter">'</span><span class="content">/book/create</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test saving a valid book</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        params.title = <span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>
        params.pages = <span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span>

        controller.save()

        <span class="key">then</span>:
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/book/show/1</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>
        <span class="predefined-type">Book</span>.count() == <span class="integer">1</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>mockDomain</code> method also includes an additional parameter that lets you pass a List of Maps to configure a domain, which is useful for fixture-like data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">mockDomain(<span class="predefined-type">Book</span>, [
            [<span class="key">title</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>, <span class="key">pages</span>: <span class="integer">1000</span>],
            [<span class="key">title</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">The Shining</span><span class="delimiter">&quot;</span></span>, <span class="key">pages</span>: <span class="integer">400</span>],
            [<span class="key">title</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Along Came a Spider</span><span class="delimiter">&quot;</span></span>, <span class="key">pages</span>: <span class="integer">300</span>] ])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_constraints">Testing Constraints</h4>
<div class="paragraph">
<p>There are 3 types of validateable classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Domain classes</p>
</li>
<li>
<p>Classes which implement the <code>Validateable</code> trait</p>
</li>
<li>
<p>Command Objects which have been made validateable automatically</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are all easily testable in a unit test with no special configuration necessary as long as the test method is marked with <code>TestFor</code> or explicitly applies the <code>GrailsUnitTestMixin</code> using <code>TestMixin</code>.  See the examples below.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/com/demo/MyValidateable.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="type">class</span> <span class="class">MyValidateable</span> <span class="directive">implements</span> grails.validation.Validateable {
    <span class="predefined-type">String</span> name
    <span class="predefined-type">Integer</span> age

    <span class="directive">static</span> constraints = {
        name <span class="key">matches</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">[A-Z].*</span><span class="delimiter">/</span></span>
        age <span class="key">range</span>: <span class="integer">1</span>..<span class="integer">99</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/com/demo/Person.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> name

    <span class="directive">static</span> constraints = {
        name <span class="key">matches</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">[A-Z].*</span><span class="delimiter">/</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/com/demo/DemoController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="type">class</span> <span class="class">DemoController</span> {

    <span class="keyword">def</span> <span class="function">addItems</span>(MyCommandObject co) {
        <span class="keyword">if</span>(co.hasErrors()) {
            render <span class="string"><span class="delimiter">'</span><span class="content">something went wrong</span><span class="delimiter">'</span></span>
        } <span class="keyword">else</span> {
            render <span class="string"><span class="delimiter">'</span><span class="content">items have been added</span><span class="delimiter">'</span></span>
        }
    }
}

<span class="type">class</span> <span class="class">MyCommandObject</span> {
    <span class="predefined-type">Integer</span> numberOfItems

    <span class="directive">static</span> constraints = {
        numberOfItems <span class="key">range</span>: <span class="integer">1</span>..<span class="integer">10</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/unit/com/demo/PersonSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(Person)
<span class="type">class</span> <span class="class">PersonSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test that name must begin with an upper case letter</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">the name begins with a lower letter</span><span class="delimiter">'</span></span>
        <span class="keyword">def</span> p = <span class="keyword">new</span> Person(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">jeff</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation should fail</span><span class="delimiter">'</span></span>
        !p.validate()

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">the name begins with an upper case letter</span><span class="delimiter">'</span></span>
        p = <span class="keyword">new</span> Person(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation should pass</span><span class="delimiter">'</span></span>
        p.validate()
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/unit/com/demo/DemoControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="keyword">import</span> <span class="include">grails.test.mixin.TestFor</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestFor</span>(DemoController)
<span class="type">class</span> <span class="class">DemoControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test an invalid number of items</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        params.numberOfItems = <span class="integer">42</span>
        controller.addItems()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">something went wrong</span><span class="delimiter">'</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test a valid number of items</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        params.numberOfItems = <span class="integer">8</span>
        controller.addItems()

        <span class="key">then</span>:
        response.text == <span class="string"><span class="delimiter">'</span><span class="content">items have been added</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/unit/com/demo/MyValidateableSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="keyword">import</span> <span class="include">grails.test.mixin.TestMixin</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.support.GrailsUnitTestMixin</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>


<span class="annotation">@TestMixin</span>(GrailsUnitTestMixin)
<span class="type">class</span> <span class="class">MyValidateableSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test validate can be invoked in a unit test with no special configuration</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">an object is valid</span><span class="delimiter">'</span></span>
        <span class="keyword">def</span> validateable = <span class="keyword">new</span> MyValidateable(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Kirk</span><span class="delimiter">'</span></span>, <span class="key">age</span>: <span class="integer">47</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validate() returns true and there are no errors</span><span class="delimiter">'</span></span>
        validateable.validate()
        !validateable.hasErrors()
        validateable.errors.errorCount == <span class="integer">0</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">an object is invalid</span><span class="delimiter">'</span></span>
        validateable.name = <span class="string"><span class="delimiter">'</span><span class="content">kirk</span><span class="delimiter">'</span></span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validate() returns false and the appropriate error is created</span><span class="delimiter">'</span></span>
        !validateable.validate()
        validateable.hasErrors()
        validateable.errors.errorCount == <span class="integer">1</span>
        validateable.errors[<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>].code == <span class="string"><span class="delimiter">'</span><span class="content">matches.invalid</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">the clearErrors() is called</span><span class="delimiter">'</span></span>
        validateable.clearErrors()

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">the errors are gone</span><span class="delimiter">'</span></span>
        !validateable.hasErrors()
        validateable.errors.errorCount == <span class="integer">0</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">the object is put back in a valid state</span><span class="delimiter">'</span></span>
        validateable.name = <span class="string"><span class="delimiter">'</span><span class="content">Kirk</span><span class="delimiter">'</span></span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validate() returns true and there are no errors</span><span class="delimiter">'</span></span>
        validateable.validate()
        !validateable.hasErrors()
        validateable.errors.errorCount == <span class="integer">0</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/unit/com/demo/MyCommandObjectSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> com.demo

<span class="keyword">import</span> <span class="include">grails.test.mixin.TestMixin</span>
<span class="keyword">import</span> <span class="include">grails.test.mixin.support.GrailsUnitTestMixin</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@TestMixin</span>(GrailsUnitTestMixin)
<span class="type">class</span> <span class="class">MyCommandObjectSpec</span> <span class="directive">extends</span> Specification {

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test that numberOfItems must be between 1 and 10</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">numberOfItems is less than 1</span><span class="delimiter">'</span></span>
        <span class="keyword">def</span> co = <span class="keyword">new</span> MyCommandObject()
        co.numberOfItems = <span class="integer">0</span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation fails</span><span class="delimiter">'</span></span>
        !co.validate()
        co.hasErrors()
        co.errors[<span class="string"><span class="delimiter">'</span><span class="content">numberOfItems</span><span class="delimiter">'</span></span>].code == <span class="string"><span class="delimiter">'</span><span class="content">range.toosmall</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">numberOfItems is greater than 10</span><span class="delimiter">'</span></span>
        co.numberOfItems = <span class="integer">11</span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation fails</span><span class="delimiter">'</span></span>
        !co.validate()
        co.hasErrors()
        co.errors[<span class="string"><span class="delimiter">'</span><span class="content">numberOfItems</span><span class="delimiter">'</span></span>].code == <span class="string"><span class="delimiter">'</span><span class="content">range.toobig</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">numberOfItems is greater than 1</span><span class="delimiter">'</span></span>
        co.numberOfItems = <span class="integer">1</span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation succeeds</span><span class="delimiter">'</span></span>
        co.validate()
        !co.hasErrors()

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">numberOfItems is greater than 10</span><span class="delimiter">'</span></span>
        co.numberOfItems = <span class="integer">10</span>

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">validation succeeds</span><span class="delimiter">'</span></span>
        co.validate()
        !co.hasErrors()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it for testing constraints. One final thing we would like to say is that testing the constraints in this way catches a common error: typos in the "constraints" property name which is a mistake that is easy to make and equally easy to overlook. A unit test for your constraints will highlight the problem straight away.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hibernatespec_and_mongospec_basics">HibernateSpec and MongoSpec Basics</h4>
<div class="paragraph">
<p><code>HibernateSpec</code> allows Hibernate to be used in Grails unit tests. It uses a H2 in-memory database. The following documentation covers <code>HibernateSpec</code>, but the same concepts can be applied to <code>MongoSpec</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.test.hibernate.HibernateSpec</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>


<span class="type">class</span> <span class="class">PersonSpec</span> <span class="directive">extends</span> HibernateSpec {

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test count people</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">expect</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Test execute Hibernate count query</span><span class="delimiter">&quot;</span></span>
            Person.count() == <span class="integer">0</span>
            sessionFactory != <span class="predefined-constant">null</span>
            transactionManager != <span class="predefined-constant">null</span>
            hibernateSession != <span class="predefined-constant">null</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default <code>HibernateSpec</code> will scan for domain classes within the package specified by the <code>grails.codegen.defaultPackage</code> configuration option or if not specified the same package as the test.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_domain_classes_for_hibernatespec_tests">Configuring domain classes for HibernateSpec tests</h4>
<div class="paragraph">
<p>If you only wish to test a limited set of domain classes you can override the <code>getDomainClasses</code> method to specify exactly which ones you wish to test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.test.hibernate.HibernateSpec</span>

<span class="type">class</span> <span class="class">PersonSpec</span> <span class="directive">extends</span> HibernateSpec {
    ...

    List&lt;<span class="predefined-type">Class</span>&gt; getDomainClasses() { [ Person ] }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_controllers_and_services_with_hibernatespec">Testing Controllers and Services with HibernateSpec</h4>
<div class="paragraph">
<p>If you wish to test a controller or a service with <code>HibernateSpec</code> generally you can combine <code>HibernateSpec</code> with Grails' default test mixins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.test.hibernate.HibernateSpec</span>

<span class="annotation">@TestFor</span>(BookController)
<span class="type">class</span> <span class="class">BookControllerUnitSpec</span> <span class="directive">extends</span> HibernateSpec {

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if the controller or service uses <code>@Transactional</code> you will need to assign the transaction manager within the unit test&#8217;s <code>setup</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">setup</span>() {
    controller.transactionManager = transactionManager
}</code></pre>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/unitTestingTagLibraries.html">&lt;&lt; <strong>3</strong><span>Unit Testing Tag Libraries</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/unitTestingFilters.html"><strong>5</strong><span>Unit Testing Filters</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
